<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users List</title>
    <link rel="stylesheet" href="/CSS/table_users.css">
    <link rel="stylesheet" href="/CSS/header.css">
    <link rel="stylesheet" href="/CSS/popup.css">
    <link rel="stylesheet" href="/CSS/btn-back-next.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>

<body>
    <div class="header">
        <div class="logo-container">
            <img src="/assets/images/TSU.png" alt="TSU Logo">
            <img src="/assets/images/SMP.png" alt="SMP Logo">
        </div>
        <div>
            <h2>โครงการ วมว. - มอ.ทักษิณ</h2>
            <p>โครงการห้องวิทยาศาสตร์ในโรงเรียนป่าพะยอมพิทยาคม โดยการกำกับดูแลมหาลับทักษิณ</p>
        </div>
        <div class="admin-info dropdown">
            <span id="adminName"></span>
            <img src="/assets/icons/admin-icon.png" alt="Admin Icon">
            <div class="dropdown-content">
                <a href="/admin/profile">Profile</a>
                <a href="#" onclick="logout()">Log out</a>
            </div>
        </div>
    </div>

    <button class="back-button"  onclick="goBack()">
        <i class="fas fa-arrow-left"></i> รายละเอียดโครงการ
    </button>

    <!-- Popup ยืนยันการลบ -->
<div id="confirmDeletePopup" class="popup-delete-container">
    <div class="popup-confirm-content">
        <span class="popup-delete-icon"><img src="/assets/icons/warning.png" alt="warning"></span>
        <h2>ยืนยันการลบโครงการ</h2>
        <p>คุณแน่ใจหรือไม่ว่าต้องการลบโครงการนี้?</p>
        <div class="btn-confirm">
            <button class="confirm-content" onclick="confirmDelete()">ยืนยัน</button>
            <button class="cancel-content" onclick="cancelDelete()">ยกเลิก</button>
        </div>
        
    </div>
    
</div>

   <!-- Popup เมื่อ delete สำเร็จ -->
   <div id="successPopup" class="popup-delete-container">
    <div class="popup-delete-content">
        <span class="popup-delete-icon"><img src="/assets/icons/trash.png" alt="success"></span>
        <h2>ลบโครงการ สำเร็จ</h2>
    </div>
</div>

   
    
    <div class="table-user-container">

        <h2>รายชื่อผู้สมัคร <img src="/assets/icons/contact-list.png" alt="User List Icon" style="height: 40px; width: 40px;"></h2>

    <table id="usersTable">
        <thead>
            <tr>
                <th>ลำดับ</th>
                <th>User ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Phone Number</th>
                <th>Email</th>
                <th>action</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- ข้อมูลผู้ใช้จะถูกเพิ่มที่นี่ -->
        </tbody>
    </table>
    <div id="pagination" class="btn-next-back">
        <button id="prevBtn" class="pagination-btn-back" onclick="prevPage()">
            <i class="fas fa-chevron-left"></i> ย้อนกลับ
        </button>
        <span id="pageNumbers"></span>
        <button id="nextBtn" class="pagination-btn-next" onclick="nextPage()">
            ถัดไป <i class="fas fa-chevron-right"></i>
        </button>
    </div>

</div>

    <script>
        let currentPage = 1;
        const rowsPerPage = 5;
        let UsersData = [];
        let projectId;
        let userIdToDelete = null; // ตัวแปรเก็บ user ID ที่จะลบ
        const accessToken = localStorage.getItem('accessToken');

        async function fetchUsers() {
            const urlParams = new URLSearchParams(window.location.search);
                projectId = urlParams.get('id');
            if (!projectId) {
                alert('Project ID not found in the URL.');
                window.location.href = '/admin/projects';
                return;
            }

            checkToken();

            try {
                const response = await fetch(`/api/admin/get/users/${projectId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    UsersData = data; // Store fetched data
                    displayUsers();   // Initial display of the first page
                    setupPagination();   // Setup pagination numbers
                } else {
                    throw new Error('Unauthorized or error fetching users');
                }
            } catch (error) {
                console.error('Error fetching users:', error);
                alert('Error fetching users: ' + error.message);
            }
        }

        function displayUsers() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = ''; // Clear the table

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const currentUsers = UsersData.slice(start, end);

            currentUsers.forEach((user, index) => {
                        const row = tableBody.insertRow();
                        row.insertCell(0).textContent = index + 1;
                        row.insertCell(1).textContent = user.User_id || '-';
                        row.insertCell(2).textContent = user.User_Fname || '-';
                        row.insertCell(3).textContent = user.User_Lname || '-';
                        row.insertCell(4).textContent = user.User_phone_num || '-';
                        row.insertCell(5).textContent = user.User_email || '-';

                        const actionsCell = row.insertCell(6);
                        actionsCell.innerHTML = `
                            <span class="action-icons">
                                <div class="icon-container">
                                    <img src="/assets/icons/research.png" onclick="viewDetails('${user.User_id}')">
                                    <span class="tooltip">ตรวจสอบ</span>
                                </div>
                                <div class="icon-container">
                                    <img src="/assets/icons/bin.png" onclick="deleteUser('${user.User_id}')">
                                    <span class="tooltip">ลบ</span>
                                </div>
                            </span>
                        `;
                    });

            document.getElementById('pageNumbers').textContent = `Page ${currentPage}`;
        }

        function setupPagination() {
            const pageCount = Math.ceil(UsersData.length / rowsPerPage);
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === pageCount;

            document.getElementById('pageNumbers').textContent = `Page ${currentPage} of ${pageCount}`;
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                displayUsers();
                setupPagination();
            }
        }

        function nextPage() {
            const pageCount = Math.ceil(UsersData.length / rowsPerPage);
            if (currentPage < pageCount) {
                currentPage++;
                displayUsers();
                setupPagination();
            }
        }

        function viewDetails(userId) {
            window.location.href = `/admin/user/examine?id=${userId}`;
        }

        // Delete project function
        async function deleteUser(userId) {
            userIdToDelete = userId; // เก็บ user ID ไว้ในตัวแปร
            document.getElementById('confirmDeletePopup').style.display = 'flex'; // แสดง Popup
        }

        function confirmDelete() {
            checkToken();

            fetch(`/api/admin/delete/user/${userIdToDelete}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    showSuccessPopup();
                    
                } else {
                    throw new Error('Error deleting user');
                }
            })
            .catch(error => {
                console.error('Error deleting user:', error);
                alert('Error deleting user: ' + error.message);
            })
            .finally(() => {
                userIdToDelete = null; // รีเซ็ตตัวแปร user ID
                document.getElementById('confirmDeletePopup').style.display = 'none'; // ซ่อน Popup
            });
        }


        function cancelDelete() {
            userIdToDelete = null; // รีเซ็ตตัวแปร user ID
            document.getElementById('confirmDeletePopup').style.display = 'none'; // ปิด Popup หากยกเลิก
        }

        function showSuccessPopup() {
            const popup = document.getElementById('successPopup');
            popup.style.display = 'flex'; // แสดง popup

            setTimeout(() => {
                popup.style.display = 'none'; // ปิด popup หลัง 3 วินาที
                fetchUsers(); // Refresh the user list
            }, 2000);
     }

        

     function checkToken(){
            
            
            if (!accessToken) {
                alert('Access token not found. Please login again.');
                logout();
                return;
            }
        }

        function goBack() {
            window.location.href = `/admin/project/view/?id=${projectId}`;
        }

        


        document.getElementById('adminName').textContent = localStorage.getItem('userName');

        function logout() {
            localStorage.removeItem('accessToken'); // Clear the token
            localStorage.removeItem('refreshToken'); 
            localStorage.removeItem('userName'); // Clear the username
            localStorage.removeItem('admin_id'); 
            window.location.href = '/smp/sci/tsu'; // Redirect to login page after logout
        }


        fetchUsers();
    </script>
</body>

</html>
