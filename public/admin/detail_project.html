<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายละเอียดโครงการ</title>
    <link rel="stylesheet" href="/CSS/header.css">
    <link rel="stylesheet" href="/CSS/popup.css">
    <link rel="stylesheet" href="/CSS/detail_project.css">  <!-- เชื่อมไฟล์ CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"> <!-- เพิ่ม FontAwesome สำหรับไอคอน -->
</head>

<body>

    <!-- Header section -->
    <div class="header">
        <div class="logo-container">
            <img src="/assets/images/TSU.png" alt="TSU Logo">
            <img src="/assets/images/SMP.png" alt="SMP Logo">
        </div>
        <div>
            <h2>โครงการ วมว. - มอ.ทักษิณ</h2>
            <p>โครงการห้องวิทยาศาสตร์ในโรงเรียนป่าพะยอมพิทยาคม โดยการกำกับดูแลมหาลับทักษิณ</p>
        </div>
        <div class="admin-info dropdown">
            <span id="adminName"></span>
            <img src="/assets/icons/admin-icon.png" alt="Admin Icon">
            <div class="dropdown-content">
                <a href="/admin/profile">โปรไฟล์</a>
                <a href="#" onclick="logout()">ออกจากระบบ</a>
            </div>
        </div>
    </div>


    <!-- Popup เมื่อ delete สำเร็จ -->
<div id="successPopup" class="popup-delete-container">
    <div class="popup-delete-content">
        <span class="popup-delete-icon"><img src="/assets/icons/trash.png" alt="success"></span>
        <h2>ลบโครงการ สำเร็จ</h2>
    </div>
</div>

<!-- Popup ยืนยันการลบ -->
<div id="confirmDeletePopup" class="popup-delete-container">
    <div class="popup-confirm-content">
        <span class="popup-delete-icon"><img src="/assets/icons/warning.png" alt="warning"></span>
        <h2>ยืนยันการลบโครงการ</h2>
        <p>คุณแน่ใจหรือไม่ว่าต้องการลบโครงการนี้?</p>
        <div class="btn-confirm">
            <button class="confirm-content" onclick="confirmDelete()">ยืนยัน</button>
            <button class="cancel-content" onclick="cancelDelete()">ยกเลิก</button>
        </div>
        
    </div>
    
</div>


    <!-- Header for project details and buttons -->
<div class="header-container">
    <h1>รายละเอียดโครงการ <img src="/assets/icons/file.png" alt="Add Icon" style="height: 40px; width: 40px;"> </h1>

    <!-- ปุ่มแก้ไขและลบ -->
    <div class="top-buttons">
        <button class="edit" onclick="editProject()">
            <i class="fas fa-edit"></i> แก้ไข
        </button>
        <button class="delete" onclick="deleteProject()">
            <i class="fas fa-trash"></i> ลบ
        </button>
    </div>
</div>




    <div class="project-details">
        <!-- รายละเอียดโครงการ -->
        <h2 id="projectName"></h2>
        
        <div class="file-container">
         <iframe id="projectFileIframe"
            width="50%" 
            height="600px" 
            style="border: none;">
        </iframe>
                <br>
                <span>
                    <img src="/assets/icons/pdf.png" alt="" style="height: 32px; width: 32px;">
                    <a id="projectFileLink" href="#" target="_blank"></a>
                 </span>
            
        </div>
        <div class="date-container">
        <p class="dates"><label>วันเปิดรับสมัคร:</label> <span id="startDate"></span> - <span id="endDate"></span></p>
        </div>
        

        <!-- ปุ่มกลับไปยังรายการและตรวจสอบรายชื่อ -->
        <div class="bottom-buttons">
            <button class="back" onclick="window.location.href = '/admin/projects';">
                <i class="fas fa-arrow-left"></i> กลับไปยังรายการ
            </button>
            <button class="check" onclick="viewUsers()">
                <i class="fas fa-users"></i> ตรวจสอบรายชื่อ
            </button>
        </div>
    </div>


    <script>
        const accessToken = localStorage.getItem('accessToken');

        function formatDate(dateString) {
            const options = {
                year: 'numeric',
                month: 'long',  // ใช้ 'long' เพื่อแสดงชื่อเดือนเต็ม
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false // ใช้ 24 ชั่วโมง
            };
            const date = new Date(dateString);
            return date.toLocaleString('th-TH', options); // ตั้ง locale เป็น 'th-TH' สำหรับวันที่ไทย
                }

        // Fetch project details function
        async function fetchProjectDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');

            if (!projectId) {
                alert('ไม่พบรหัสโครงการใน URL');
                window.location.href = '/admin/projects';
                return;
            }

            checkToken();

            try {
                const response = await fetch(`/api/admin/project/${projectId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const project = await response.json();
                    document.getElementById('projectName').textContent = project.project_name;

                    document.getElementById('startDate').textContent = formatDate(project.project_start_date);
                    document.getElementById('endDate').textContent = formatDate(project.project_expiration_date);
                    document.getElementById('projectFileLink').textContent = project.project_file;

                    // ตั้งค่า iframe src สำหรับแสดงไฟล์ PDF
                    const iframe = document.getElementById('projectFileIframe');
                    if (iframe && project.project_file) {
                        iframe.src = `/uploads/ProjectFile/${project.project_file}`;
                    }

                    document.getElementById('projectFileLink').href = `/uploads/ProjectFile/${project.project_file}`;  // ตั้งค่าลิงก์ไฟล์
                } else if (response.status === 404) {
                    alert('ไม่พบโครงการ');
                    window.location.href = '/admin/projects';
                } else {
                    throw new Error('เกิดข้อผิดพลาดในการดึงข้อมูลโครงการ');
                }
            } catch (error) {
                console.error('Error fetching project details:', error);
                alert('Error fetching project details: ' + error.message);
                window.location.href = '/admin/projects';
            }
        }

        // Edit project function
        function editProject() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');

            if (projectId) {
                window.location.href = `/admin/project/edit?id=${projectId}`;
            } else {
                alert('ไม่พบรหัสโครงการ');
            }
        }

        // Delete project function
        async function deleteProject() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');

            if (!projectId) {
                alert('ไม่พบรหัสโครงการ');
                return;
            }

            // แสดง Popup ยืนยันการลบ
            document.getElementById('confirmDeletePopup').style.display = 'flex'; 

            
        }


        // View users function
        function viewUsers() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');

            if (projectId) {
                window.location.href = `/admin/list/users?id=${projectId}`;
            } else {
                alert('ไม่พบรหัสโครงการ');
            }
        }

        function confirmDelete() {
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('id');

    

    checkToken();

    // ดำเนินการลบโครงการ
    fetch(`/api/admin/delete/project/${projectId}`, {
        method: 'DELETE',
        headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.ok) {
            showSuccessPopup();
        } else {
            throw new Error('เกิดข้อผิดพลาดในการลบโครงการ');
        }
    })
    .catch(error => {
        console.error('Error deleting project:', error);
        alert('Error deleting project: ' + error.message);
    })
    .finally(() => {
        document.getElementById('confirmDeletePopup').style.display = 'none'; 
    });
}

        function checkToken(){
            
            if (!accessToken) {
                alert('Access token not found. Please login again.');
                logout();
                return;
            }
        }


        

     function showDeletePopup() {
        const popup = document.getElementById('confirmDeletePopup');
        popup.style.display = 'flex'; // แสดง Popup
    }

    function cancelDelete() {
        document.getElementById('confirmDeletePopup').style.display = 'none'; // ปิด Popup หากยกเลิก
    }

    function showSuccessPopup() {
            const popup = document.getElementById('successPopup');
            popup.style.display = 'flex'; // แสดง popup

            setTimeout(() => {
                popup.style.display = 'none'; // ปิด popup หลัง 3 วินาที
                window.location.href = '/admin/projects'; // เปลี่ยนเส้นทางหลังจากปิด popup
            }, 2000);
     }

        // Display admin name
        document.getElementById('adminName').textContent = localStorage.getItem('userName');

        // Logout function
        function logout() {
            localStorage.removeItem('accessToken'); // Clear the token
            localStorage.removeItem('refreshToken'); 
            localStorage.removeItem('userName'); // Clear the username
            localStorage.removeItem('admin_id'); 
            window.location.href = '/smp/sci/tsu'; // เปลี่ยนเส้นทางไปยังหน้าล็อกอิน
        }

        fetchProjectDetails();
    </script>
</body>

</html>
