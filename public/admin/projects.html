<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projects</title>
    <link rel="stylesheet" href="/CSS/table_project.css">
    <link rel="stylesheet" href="/CSS/header.css">
    <link rel="stylesheet" href="/CSS/btn-back-next.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="header">
        <div class="logo-container">
            <img src="/assets/images/TSU.png" alt="TSU Logo">
            <img src="/assets/images/SMP.png" alt="SMP Logo">
        </div>
        <div>
            <h2>โครงการ วมว. - มอ.ทักษิณ</h2>
            <p>โครงการห้องวิทยาศาสตร์ในโรงเรียนป่าพะยอมพิทยาคม โดยการกำกับดูแลมหาลับทักษิณ</p>
        </div>
        <div class="admin-info dropdown">
            <span id="adminName"></span>
            <img src="/assets/icons/admin-icon.png" alt="Admin Icon">
            <div class="dropdown-content">
                <a href="/admin/profile">Profile</a>
                <a href="#" onclick="logout()">Log out</a>
            </div>
        </div>
    </div>




    <div class="table-project-container">

        <h2>รายการโครงการ <img src="/assets/icons/to-do-list.png" alt="Add Icon" style="height: 40px; width: 40px;"> </h2> 
        <button class="add-button" onclick="window.location.href = '/admin/add/project';">
            ADD
            <img src="/assets/icons/add.png" alt="Add Icon">
        </button>

        <table id="projectsTable">
            <thead>
                <tr>
                    <th>ลำดับ</th> <!-- New Rank column -->
                    <th>รหัสโครงการ</th>
                    <th>ชื่อโครงการ</th>
                    <th>วันเปิดรับสมัคร</th>
                    <th>วันปิดรับสมัคร</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                
            </tbody>
        </table>
        <div id="pagination" class="btn-next-back">
            <button id="prevBtn" class="pagination-btn-back" onclick="prevPage()">
                <i class="fas fa-chevron-left"></i> ย้อนกลับ
            </button>
            <span id="pageNumbers"></span>
            <button id="nextBtn" class="pagination-btn-next" onclick="nextPage()">
                ถัดไป <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    <script>

        let currentPage = 1;
        const rowsPerPage = 5;
        let projectsData = [];
        const accessToken = localStorage.getItem('accessToken');

         // Logout function
         function logout() {
            localStorage.removeItem('accessToken'); // Clear the token
            localStorage.removeItem('refreshToken'); 
            localStorage.removeItem('userName'); // Clear the username
            localStorage.removeItem('admin_id'); 
            window.location.href = '/smp/sci/tsu'; // Redirect to login page after logout
        }
        function formatDate(dateString) {
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false // Use 24-hour format
            };
            const date = new Date(dateString);
            return date.toLocaleString('en-GB', options); // 'en-GB' for DD-MM-YYYY HH:mm:ss
        }

        async function fetchProjects() {
            
            checkToken();

            try {
                const response = await fetch('/api/admin/projects', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    projectsData = data; // Store fetched data
                    displayProjects();   // Initial display of the first page
                    setupPagination();   // Setup pagination numbers
                } else {
                    throw new Error('Unauthorized or error fetching project data');
                }
            } catch (error) {
                console.error('Error fetching project data:', error);
                alert('Error fetching project data: ' + error.message);
                window.location.href = '/smp/sci/tsu'; 
            }
        }

        function displayProjects() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = ''; // Clear the table

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const currentProjects = projectsData.slice(start, end);

            currentProjects.forEach((project, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = start + index + 1;
                row.insertCell(1).textContent = project.project_id;
                row.insertCell(2).textContent = project.project_name;
                row.insertCell(3).textContent = formatDate(project.project_start_date);
                row.insertCell(4).textContent = formatDate(project.project_expiration_date);

                const actionsCell = row.insertCell(5);
                actionsCell.innerHTML = `
                    <span class="action-icons">
                        <img src="/assets/icons/research.png" onclick="viewProject('${project.project_id}')">
                        <span class="tooltip">ตรวจสอบ</span>
                    </span>
                `;
            });

            document.getElementById('pageNumbers').textContent = `Page ${currentPage}`;
        }

        function setupPagination() {
            const pageCount = Math.ceil(projectsData.length / rowsPerPage);
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === pageCount;

            document.getElementById('pageNumbers').textContent = `Page ${currentPage} of ${pageCount}`;
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                displayProjects();
                setupPagination();
            }
        }

        function nextPage() {
            const pageCount = Math.ceil(projectsData.length / rowsPerPage);
            if (currentPage < pageCount) {
                currentPage++;
                displayProjects();
                setupPagination();
            }
        }

        function viewProject(projectId) {
            window.location.href = `/admin/project/view/?id=${projectId}`;
        }

        function checkToken(){
            if (!accessToken) {
                alert('Access token not found. Please login again.');
                logout();
                return;
            }
        }
        
        // Set admin name on page load
        document.getElementById('adminName').textContent = localStorage.getItem('userName');

        fetchProjects();
    </script>
</body>
</html>
